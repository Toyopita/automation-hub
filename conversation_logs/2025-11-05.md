# 会話ログ - 2025年11月5日

## セッション1: 献品・記念品管理システム
- 開始: 15:13頃
- 終了: 17:16頃

## セッション2: OCR→カレンダー登録Bot
- 開始: 19:31頃
- 現在進行中

---

## 主要な作業内容

### 1. 記念品発注管理の改善
**要求:**
- 祖霊社の記念品DBには「発注先」プロパティがあるので、発注先を選択できるようにしたい

**実装内容:**
- `gift_order_monitor.py`を修正
- 関係団体DBから発注先リストを取得する機能追加
- 発注先選択UI（SelectMenu with Pagination）を追加
- フロー: DB選択 → プロジェクト選択 → 発注先選択（祖霊社のみ） → Modal入力
- 「指定しない」オプションも追加

**変更ファイル:**
- `/Users/minamitakeshi/discord-mcp-server/gift_order_monitor.py`

**データベースID:**
- 祖霊社記念品発注管理: `1ca00160-1818-8023-b120-ee4dd54fc2c3`
- 本社記念品発注記録DB: `18800160-1818-804b-9097-cde17e8923fb`
- 関係団体DB: `14d00160-1818-800f-a949-f99fefc96065`

---

### 2. 献品（献米・献酒）管理システムの実装
**要求:**
- Discordで「米」「酒」と投稿するだけで、Notionに献品を登録したい
- 献米と献酒のDBは別々
- 分類と奉納月は手動選択
- 献酒は一括登録したい
- 献米は同じ種類でもキロ数が違う場合があるので、「続けて登録」方式にしたい

**実装内容:**

#### 献米フロー:
1. 「米」と投稿
2. 📂 分類選択（本部/祖霊社/使用/未設定）
3. 📅 奉納月選択（1月〜12月）
4. 🌾 種類選択（白/黒/モチ/その他）
5. Modal入力（キロ数、袋数）
6. ✅ 登録完了 → 「続けて登録する」ボタン表示
   - ボタンで同じ分類・月のまま種類選択に戻る

#### 献酒フロー:
1. 「酒」と投稿
2. 📂 分類選択（本部/祖霊社/使用/未設定）
3. 📅 奉納月選択（1月〜12月）
4. 🍶 種類を複数選択（賀茂鶴/樽酒/上撰/飛翔/典雅/その他、最大5種類）
5. Modal一括入力（選択した種類分の本数入力）
6. ✅ 一括登録完了

**変更ファイル:**
- `/Users/minamitakeshi/discord-mcp-server/kenpin_monitor.py`（新規作成）

**データベースID:**
- 献米DB: `28000160-1818-80a1-94e3-f87262777dec`
- 献酒DB: `18700160-1818-802b-afef-d94a672cee11`

**DBプロパティ構造:**

献米DB:
- 商品名（title）: 種類（白、黒など）
- キロ数（number）: 1袋あたりのキロ数
- 数量（number）: 袋数
- 総㌔数（formula）: キロ数 × 数量（自動計算）
- 分類（select）: 本部/祖霊社/使用/未設定
- 奉納年（select）: 自動で現在の年
- 奉納月（select）: 手動選択

献酒DB:
- 商品名（title）: 種類（賀茂鶴など）
- 数量（number）: 本数
- 分類（select）: 本部/祖霊社/使用/未設定
- 奉納年（select）: 自動で現在の年
- 奉納月（select）: 手動選択

---

### 3. チャンネルの本番化
**要求:**
- 献品チャンネルから「テスト」という文字を削除
- 使い方をチャンネルに投稿してピン留め
- 絵文字を献品らしいものに変更
- 記念品発注チャンネルにも使い方を投稿

**実施内容:**
1. チャンネル名変更:
   - 🍶🌾｜献品テスト → 🙏｜献品 → 🌾｜献品
2. 使い方投稿 & ピン留め（献品チャンネル）
3. 使い方投稿（記念品発注チャンネル）

**チャンネルID:**
- 献品（IZUMOサーバー）: `1435510401600327781`
- 記念品発注（IZUMOサーバー）: `1435473542006308947`

---

### 4. IZUMOサーバー専用化
**要求:**
- デフォルトはIZUMOサーバーのみ使用
- Minamiサーバーが必要な時は明示的に指定する

**実施内容:**
- `kenpin_monitor.py`: MinamiサーバーのチャンネルIDを削除
- `gift_order_monitor.py`: MinamiサーバーのチャンネルIDを削除
- 両Bot再起動

---

## 重要な決定事項

1. **献米の一括登録を諦めた理由:**
   - 同じ種類でもキロ数が違う場合がある（例: 黒30kg×30袋、黒15kg×20袋）
   - Modalの制限（最大5フィールド）では対応できない
   - 「続けて登録」ボタン方式に変更

2. **デフォルトサーバー:**
   - IZUMOサーバーをデフォルトとする
   - Minamiサーバーは明示的に指定が必要

3. **環境変数の使い分け:**
   - `NOTION_TOKEN_RICE`: 献米DB用
   - `NOTION_TOKEN_SAKE`: 献酒DB用
   - `NOTION_TOKEN_ORDER`: 記念品発注DB・関係団体DB用

---

## 起動中のBot一覧

1. **kenpin_monitor.py** - 献品管理Bot
   - チャンネル: 🌾｜献品（IZUMOサーバー）
   - 機能: 献米・献酒の登録

2. **gift_order_monitor.py** - 記念品発注管理Bot
   - チャンネル: 🎁｜記念品発注記録（IZUMOサーバー）
   - 機能: 記念品発注の登録

3. **その他の常時実行Bot:**
   - calendar_monitor.py
   - book_bot.py
   - order_notification.py（停止中）
   - sake_monitor.py
   - rice_monitor.py

---

## 次回セッション時の参考情報

### 献品システムの使い方
- 「米」投稿 → 分類・月・種類選択 → キロ数・袋数入力 → 続けて登録ボタン
- 「酒」投稿 → 分類・月選択 → 複数種類選択 → 一括入力

### 記念品発注システムの使い方
- 商品名投稿 → DB選択（祖霊社/本社） → プロジェクト選択 → 発注先選択（祖霊社のみ） → Modal入力

### トラブルシューティング
- Botが反応しない場合: `ps aux | grep -E "(kenpin|gift_order)" | grep -v grep` でプロセス確認
- ログ確認: `tail ~/discord-mcp-server/kenpin_monitor.log`

---

## 未解決の課題・TODO

なし（現時点で全て完了）

---

## セッション2の作業内容（OCR→カレンダー登録Bot）

### 5. OCR→カレンダー自動登録システムの実装
**要求:**
- Minamiサーバーの指定チャンネルに画像を投稿
- OCRで文字認識してイベント情報を抽出
- Googleカレンダーに自動登録

**技術選択の経緯:**
1. 最初はTesseract OCR + regexパース → 失敗（様々な画像フォーマットに対応できない）
2. ファイルベースでClaude Code連携 → 失敗（手動介入が必要で自動化できない）
3. **Gemini API統合** → 成功（完全自動化を実現）

**実装内容:**

#### Gemini API統合:
- **モデル**: `gemini-2.0-flash-exp`
- **無料枠**: 250リクエスト/日（10リクエスト/分）
- **APIキー**: `.env`ファイルに保存
- 画像を直接Geminiに送信して解析
- イベント情報（タイトル、日付、時刻、場所、説明）をJSON形式で抽出

#### 使用量トラッキング機能:
- `~/discord-mcp-server/gemini_usage.json`に日次使用量を記録
- 日付が変わると自動リセット
- 3段階の保護:
  - 0〜199リクエスト: 正常動作（INFO ログ）
  - 200〜249リクエスト: 警告（WARNING ログ）
  - 250リクエスト以上: API呼び出し完全停止（ERROR ログ + Discordエラーメッセージ）
- Bot起動時に使用量表示: `本日のGemini API使用量: X/250 (残り: Y)`
- Discord上でも使用量表示: `📊 Gemini API使用量: X/250 (残り: Y)`

#### 複数日付対応:
- プロンプトを改善して `"dates": ["2025-11-22", "2025-11-23", ...]` の形式で返すように
- 複数日付がある場合、全ての日付でカレンダーイベントを作成
- 例: 平等院の夜間拝観（11/22, 11/23, 11/24, 11/29, 11/30, 12/6, 12/7）→ 7件のイベント作成

#### フロー:
1. ユーザーが📷｜ocrテストチャンネルに画像を投稿
2. Botが画像をダウンロード
3. Gemini APIで解析（数秒）
4. イベント情報を抽出してDiscordに表示（使用量も表示）
5. ユーザーが「登録」ボタンをクリック
6. 全ての日付でGoogleカレンダーにイベント作成
7. 登録完了メッセージ（使用量も表示）

**変更ファイル:**
- `/Users/minamitakeshi/discord-mcp-server/ocr_calendar_bot.py`（全面改修）
- `/Users/minamitakeshi/discord-mcp-server/.env`（GEMINI_API_KEYを追加）

**チャンネルID:**
- 📷｜ocrテスト（Minamiサーバー）: `1435548125207986198`

**使用量ログファイル:**
- `~/discord-mcp-server/gemini_usage.json`

**Google Calendar API:**
- 認証情報: `~/shared-google-calendar/credentials.json`
- トークン: `~/.config/google-calendar-mcp/tokens.json`
- カレンダーID: `primary`（プライベートカレンダー）

---

### トラブルシューティング（セッション2）

**問題1: 日付が検出されない**
- 原因: 複数日付があるとGeminiが単一日付として抽出できず `"date": null` を返す
- 解決: プロンプトを改善して配列形式 `"dates": [...]` で返すように変更

**問題2: Discordで返答がダブる**
- 原因: 4つのBotプロセスが同時起動していた
- 解決: 全プロセスを停止して1つだけ起動

**問題3: 使用量が見えない**
- 原因: 使用量はログにしか記録されていなかった
- 解決: Discord上のメッセージに使用量を表示

---

### 重要な決定事項（セッション2）

1. **Gemini APIを選んだ理由:**
   - 無料（250リクエスト/日）で十分
   - 様々な画像フォーマット（Twitter、Threads、Instagram、フライヤーなど）に対応
   - 柔軟な解析（regexより遥かに高精度）
   - 完全自動化が可能

2. **使用量トラッキングを徹底:**
   - ユーザーが「絶対に有料になりたくない」と明言
   - ログファイル + Discord表示で常に使用量を確認可能
   - 250リクエスト到達で自動停止

3. **複数日付は全て登録:**
   - 1つだけ登録するのではなく、全ての日付でイベント作成
   - 例: 7日間のイベント → 7件のカレンダーイベント

---

### 起動中のBot一覧（更新）

1. **kenpin_monitor.py** - 献品管理Bot
2. **gift_order_monitor.py** - 記念品発注管理Bot
3. **ocr_calendar_bot.py** - OCR→カレンダー登録Bot（NEW）
   - チャンネル: 📷｜ocrテスト（Minamiサーバー）
   - 機能: 画像からイベント情報を抽出してカレンダー登録
   - 使用量: 本日6/250（残り244）

---

## 会話ログの保存について

**このログファイルについて:**
- 保存場所: `~/discord-mcp-server/conversation_logs/YYYY-MM-DD.md`
- 日毎に自動的にファイルを分ける
- セッションが途切れた時は、このログを読めば続きから再開可能
- 重要な決定事項、変更内容、データベースID、チャンネルIDなどを記録

**次回セッション時:**
1. 最新のログファイルを読む
2. 「主要な作業内容」で何をしたか確認
3. 「起動中のBot一覧」で現在の状態を把握
4. 「未解決の課題・TODO」があれば優先対応
