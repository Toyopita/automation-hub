# 会話ログ - 2025年11月6日

## セッション開始時刻
- 開始: 15:51頃（前回セッションからの継続）

---

## 前回セッション（2025-11-05）からの引き継ぎ事項

### 完了済みのタスク

#### 1. WordMemo自動抽出Bot実装（完了）
**ファイル:** `/Users/minamitakeshi/discord-mcp-server/daily_wordmemo_extract.py`

**機能:**
- 書籍フォーラム（ID: 1433964655172124742）を毎日深夜2時に監視
- MeCabで日本語形態素解析
- 複合語を正しく抽出（例: 「鉄器時代」を「鉄器」と「時代」に分解しない）
- Gemini APIでバッチ処理（10単語/回）してAPI使用量を90%削減
- ObsidianのWordMemoに自動追加（既存1863ファイル）

**重要な技術的決定事項:**
1. **複合語抽出ロジック:**
   - 連続する名詞を複合語として扱う
   - 重要な接尾辞（時代、文化、論、法、史、学、器、式、型）をチェック
   - 固有名詞・サ変接続を優先
   - 最小文字数: 3文字以上

2. **API効率化:**
   - 当初: 1単語につき1 API呼び出し → API上限に達する
   - 改善: 10単語を1回のAPI呼び出しでバッチ処理
   - 結果: API使用量を90%削減

3. **重複防止（3層構造）:**
   - 処理済みメッセージIDを記録（`wordmemo_processed_messages.json`）
   - 既存WordMemoファイルの存在チェック
   - 実行中のメモリ内重複チェック

**launchd設定:** `/Users/minamitakeshi/Library/LaunchAgents/com.discord.wordmemo_extract.plist`
- 実行時刻: 毎日深夜2時
- ログ: `~/discord-mcp-server/wordmemo_extract.log`
- エラーログ: `~/discord-mcp-server/wordmemo_extract_error.log`

**依存関係:**
- MeCab（日本語形態素解析器）
- mecab-python3
- discord.py
- Gemini CLI

**WordMemoルール:**
- テンプレート: `/Users/minamitakeshi/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian Vault/00_Templates/book_memo_template.md`
- ルール文書: `/Users/minamitakeshi/Library/Mobile Documents/iCloud~md~obsidian/Documents/Obsidian Vault/00_Guides/05_WordMemo_rule.md`
- 必須項目: 意味、読み方、語源、使用例、類義語、対義語、関連語、**タグ10個**
- タグ生成ルール: 内容から関連性の高いタグを自動生成（日本語基本、IT/AI等は英語可）

#### 2. 予定投稿の修正（完了）
**ファイル:** `/Users/minamitakeshi/discord-mcp-server/daily_schedule_post.py`

**変更内容:**
- 不成就日と三隣亡を六曜・日干支と同じ【　　】フォーマットで表示
- 重複を防ぐため、special_calendarsリストに追加

**表示例:**
```
**【六　曜】** 先勝
**【日干支】** 甲子
**【不成就日】** 不成就日（該当する場合のみ）
**【三隣亡】** 三隣亡（該当する場合のみ）
```

#### 3. Discordフォーラム作成（完了）
**作成したフォーラム:**
- **🍎｜apple**（ID: 1435897987694985286）
  - カテゴリ: ━━━ DX ━━━（ID: 1430450907279261747）

**作成したスレッド（Mac mini 2024モデル）:**
1. Mac mini M4（10コアCPU/10コアGPU）- $599
2. Mac mini M4 Pro（12コアCPU/16コアGPU）- $1,399
3. Mac mini M4 Pro（14コアCPU/20コアGPU）- カスタム構成

---

## 現在のシステム状態

### 稼働中のBot（常時起動）
1. **book_bot.py** - 書籍管理Bot
2. **ocr_calendar_bot.py** - OCR→カレンダー登録Bot
3. **gift_order_monitor.py** - 記念品発注管理Bot
4. **order_notification.py** - 発注通知Bot
5. **sake_monitor.py** - 酒在庫監視Bot
6. **rice_monitor.py** - 米在庫監視Bot

### 定期実行スクリプト（launchd）
1. **毎朝7時**: `daily_schedule_post.py` - 📅｜今日の予定チャンネルに投稿
2. **毎朝8時**: `daily_task_post.py` - 📋｜タスク通知チャンネルに投稿
3. **毎晩20時**: `daily_order_post.py` - 📋｜発注ログチャンネルに投稿
4. **毎日12時**: `daily_kansai_events.py` - 🎪｜イベントフォーラムに投稿
5. **毎晩深夜2時**: `daily_wordmemo_extract.py` - ObsidianのWordMemo自動抽出（新規追加）

### アーカイブされたBot（使用停止中）
- `auto_archive_channels.py` - チャンネル自動アーカイブ
- `daily_ai_news.py` - AI関連ニュース投稿
- `daily_notion_news.py` - Notionニュース投稿
- `calendar_monitor.py` - カレンダーイベント監視

---

## 重要な注意事項

### Gemini API クォータ制限
**現状:** 2025年11月6日時点でGemini API（Gemini 2.5 Pro）の1日あたりのクォータ上限に達している

**エラーメッセージ:**
```
Quota exceeded for quota metric 'Gemini 2.5 Pro Requests' and limit 'Gemini 2.5 Pro Requests per day per user per tier'
```

**原因:**
- 前回のセッションで多数のテストを実行したため
- WordMemo抽出Botのテスト実行
- 他のBot（book_bot.py、ocr_calendar_bot.py、daily_kansai_events.py）も同じAPIを使用

**対策:**
- WordMemo抽出Botはバッチ処理で効率化済み（10単語/回）
- 本番運用では1日のAPI使用量は大幅に削減される見込み
- 必要に応じてAPI上限の引き上げを検討

**復旧予定:**
- Gemini APIのクォータは日次リセット（UTC 0:00 = JST 9:00）
- 明朝9時以降に自動復旧予定

---

## データベース・チャンネルID一覧

### Notion データベースID
- **祖霊社タスクDB**: `1c800160-1818-807c-b083-f475eb3a07b9`
- **祖霊社プロジェクトDB**: `1c800160-1818-8004-9609-c1250a7e3478`
- **祖霊社記念品発注管理**: `1ca00160-1818-8023-b120-ee4dd54fc2c3`
- **本社記念品発注記録DB**: `18800160-1818-804b-9097-cde17e8923fb`
- **関係団体DB**: `14d00160-1818-800f-a949-f99fefc96065`
- **発注履歴DB**: `19800160-1818-8095-987d-eff320494e12`
- **三十三音楽製造局ページ**: `1a500160-1818-80ed-a6d1-fb9ab0cb08b3`
- **献米DB**: `28000160-1818-80a1-94e3-f87262777dec`
- **献酒DB**: `18700160-1818-802b-afef-d94a672cee11`

### Discord チャンネルID
- **📅｜今日の予定**: `1434368052916392076`
- **📋｜タスク通知**: `1433713467663962133`
- **📋｜発注ログ**: `1433713544327528598`
- **🎪｜イベントフォーラム**: `1434378905558769715`
- **📚｜書籍フォーラム**: `1433964655172124742`
- **🍎｜apple**: `1435897987694985286`（新規作成）

### Discord カテゴリID
- **━━━ DX ━━━**: `1430450907279261747`
- **━━━ Books ━━━**: `1433964655172124742`（フォーラムと同一）

---

## 未解決の課題・TODO

**現時点では特になし**

全ての要求されたタスクは完了しています。

---

## 次回セッション時の参考情報

### WordMemo抽出Botの確認方法

**手動テスト実行:**
```bash
cd ~/discord-mcp-server
source .venv/bin/activate
python3 daily_wordmemo_extract.py
```

**ログ確認:**
```bash
tail -f ~/discord-mcp-server/wordmemo_extract.log
tail -f ~/discord-mcp-server/wordmemo_extract_error.log
```

**launchd設定確認:**
```bash
launchctl list | grep discord.wordmemo
```

**処理済みメッセージリセット（テスト用）:**
```bash
rm -f ~/discord-mcp-server/wordmemo_processed_messages.json
```

### MeCab設定

**設定ファイル:** `/usr/local/etc/mecabrc`
**辞書ディレクトリ:** `/usr/local/lib/mecab/dic/ipadic`

**テストコマンド:**
```bash
echo "照葉樹林文化論" | mecab
```

### トラブルシューティング

**問題: Gemini APIクォータ超過**
- 症状: 429 Too Many Requests
- 対処: 翌朝9時（UTC 0時）まで待機

**問題: MeCabが見つからない**
- 対処: `brew install mecab mecab-ipadic`

**問題: WordMemoファイルが作成されない**
- 確認: Obsidianディレクトリのパス
- 確認: テンプレートファイルの存在
- 確認: ログファイルのエラーメッセージ

---

最終更新: 2025-11-06 15:51
