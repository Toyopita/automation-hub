# 九星気学 本命星計算システム 設定手順

## 完了した作業

### 1. 節入りカレンダーDB
- ✅ データベース作成完了
- ✅ 1900〜2070年の立春データ登録完了（171件）
- URL: https://www.notion.so/2b2001601818815b9bdbceed5e8ddc19
- プロパティ:
  - 年（Title）
  - 西暦（Number）
  - 立春（Date）

### 2. 人DB
- ✅ データベース作成完了
- ✅ テストデータ7件追加完了
- ✅ 節入りカレンダーへのRelation自動設定完了
- URL: https://www.notion.so/2b200160181881f2979ac411d61f1af8

### 3. 自動Relation設定スクリプト
- ✅ `add_person_with_risshun.py` - 新規追加時に自動Relation設定
- ✅ `update_test_risshun_relations.py` - 既存データに一括Relation設定

## 手動設定が必要な作業

### ステップ1: Formulaプロパティの式を設定

人DBには以下のFormulaプロパティが追加されています：

#### 1. 生まれ年（西暦）
- ✅ 設定済み

#### 2. 九星用_年
- ✅ 設定済み（2月3日以前を前年とする簡易版）

#### 3. 本命星
- ⚠️ 式の設定が必要
- Claude専用ページに式があるので、コピーして設定してください
- https://www.notion.so/Claude-2ae0016018188070859dd1a8deece0e1

### ステップ2: 計算結果を検証（Relationは自動設定済み）

**注意:** テストデータの節入りカレンダーRelationは既に自動設定済みです。

Formulaが正しく設定されると、自動的に以下のように計算されるはずです：

- テストA: 九星用_年=1979 → 本命星番号=3 → 三碧木星
- テストB: 九星用_年=1980 → 本命星番号=2 → 二黒土星
- テストC: 九星用_年=1984 → 本命星番号=7 → 七赤金星
- テストD: 九星用_年=1989 → 本命星番号=2 → 二黒土星
- テストE: 九星用_年=2000 → 本命星番号=9 → 九紫火星
- テストF: 九星用_年=1999 → 本命星番号=1 → 一白水星
- テストG: 九星用_年=2024 → 本命星番号=3 → 三碧木星

すべてのテストデータが期待される本命星と一致すれば、システムは正常に動作しています。

## 計算ロジックの説明

### 1. 九星用_年の決定
- 生年月日が立春より前 → 前年
- 生年月日が立春以降 → 当年

### 2. 本命星番号の計算
1. 九星用_年の各桁を合計
2. 合計が2桁なら、さらに各桁を合計（1桁になるまで）
3. `11 - (1桁の合計)` を計算
4. 結果が10以上なら9を引く
5. 結果が0なら9にする

### 3. 本命星の変換
番号から星名に変換:
1=一白水星, 2=二黒土星, 3=三碧木星, 4=四緑木星, 5=五黄土星,
6=六白金星, 7=七赤金星, 8=八白土星, 9=九紫火星

## トラブルシューティング

### Formulaがエラーになる場合
- プロパティ名が正確に一致しているか確認
- 日本語の全角・半角、スペースに注意
- Relationが正しく設定されているか確認

### 計算結果が合わない場合
- 節入りカレンダーのRelationが正しく設定されているか確認
- 立春日のデータが正しいか確認（節入りカレンダーDB）

## スクリプトの使い方

### 新しい人を追加（Relation自動設定）

```bash
cd ~/discord-mcp-server
.venv/bin/python3 add_person_with_risshun.py "名前" "YYYY-MM-DD"

# 例
.venv/bin/python3 add_person_with_risshun.py "田中太郎" "1985-03-15"
```

生年月日から自動的に対応する年の節入りカレンダーをRelationとして設定します。

### 既存データに一括でRelation設定

```bash
cd ~/discord-mcp-server
.venv/bin/python3 update_test_risshun_relations.py
```

人DBの全てのデータをスキャンし、生年月日があってRelationが未設定のものに自動的にRelationを設定します。

## 参考資料
- 国立天文台暦計算室: https://eco.mtk.nao.ac.jp/koyomi/
- 立春データ: `create_risshun_calendar.py` に1900〜2070年分を収録
