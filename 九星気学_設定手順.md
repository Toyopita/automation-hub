# 九星気学 本命星計算システム 設定手順

## 完了した作業

### 1. 節入りカレンダーDB
- ✅ データベース作成完了
- ✅ 1900〜2070年の立春データ登録完了（171件）
- URL: https://www.notion.so/2b2001601818815b9bdbceed5e8ddc19
- プロパティ:
  - 年（Title）
  - 西暦（Number）
  - 立春（Date）

### 2. 人DB
- ✅ データベース作成完了
- ✅ テストデータ7件追加完了
- ✅ 節入りカレンダーへのRelation自動設定完了
- URL: https://www.notion.so/2b200160181881f2979ac411d61f1af8

### 3. 自動Relation設定スクリプト
- ✅ `add_person_with_risshun.py` - 新規追加時に自動Relation設定
- ✅ `update_test_risshun_relations.py` - 既存データに一括Relation設定

## 手動設定が必要な作業

### ステップ1: Formulaプロパティを追加

人DBに以下の4つのFormulaプロパティを追加してください：

#### 1. 生まれ年（西暦）
- プロパティタイプ: Formula
- 式:
```
year(prop("生年月日"))
```

#### 2. 九星用_年
- プロパティタイプ: Formula
- 式:
```
lets(birthYear, year(prop("生年月日")), birthDate, prop("生年月日"), risshunRel, prop("節入りカレンダー"), risshunDate, first(risshunRel.prop("立春")), if(empty(risshunDate), birthYear, if(birthDate < risshunDate, birthYear - 1, birthYear)))
```

#### 3. 本命星番号
- プロパティタイプ: Formula
- 式:
```
lets(kyuseiYear, prop("九星用_年"), digitSum, lets(y, format(kyuseiYear), d1, toNumber(substring(y, 0, 1)), d2, toNumber(substring(y, 1, 2)), d3, toNumber(substring(y, 2, 3)), d4, toNumber(substring(y, 3, 4)), sum, d1 + d2 + d3 + d4, if(sum > 9, lets(s, format(sum), d1_2, toNumber(substring(s, 0, 1)), d2_2, toNumber(substring(s, 1, 2)), d1_2 + d2_2), sum)), raw, 11 - digitSum, if(raw > 9, raw - 9, if(raw == 0, 9, raw)))
```

#### 4. 本命星
- プロパティタイプ: Formula
- 式:
```
lets(num, prop("本命星番号"), ifs(num == 1, "一白水星", num == 2, "二黒土星", num == 3, "三碧木星", num == 4, "四緑木星", num == 5, "五黄土星", num == 6, "六白金星", num == 7, "七赤金星", num == 8, "八白土星", num == 9, "九紫火星", "エラー"))
```

### ステップ2: テストデータのRelationを設定

各テストデータの「節入りカレンダー」プロパティに対応する年を設定してください：

| 名前 | 生年月日 | 節入りカレンダー（設定する年） | 期待される本命星 |
|------|----------|----------------------------|---------------|
| テストA | 1980-02-03 | 1980 | 三碧木星 |
| テストB | 1980-02-05 | 1980 | 二黒土星 |
| テストC | 1984-08-15 | 1984 | 七赤金星 |
| テストD | 1990-01-15 | 1990 | 二黒土星 |
| テストE | 2000-02-04 | 2000 | 九紫火星 |
| テストF | 2000-02-03 | 2000 | 一白水星 |
| テストG | 2024-02-04 | 2024 | 三碧木星 |

### ステップ3: 計算結果を検証

Formulaが正しく設定されると、自動的に以下のように計算されるはずです：

- テストA: 九星用_年=1979 → 本命星番号=3 → 三碧木星
- テストB: 九星用_年=1980 → 本命星番号=2 → 二黒土星
- テストC: 九星用_年=1984 → 本命星番号=7 → 七赤金星
- テストD: 九星用_年=1989 → 本命星番号=2 → 二黒土星
- テストE: 九星用_年=2000 → 本命星番号=9 → 九紫火星
- テストF: 九星用_年=1999 → 本命星番号=1 → 一白水星
- テストG: 九星用_年=2024 → 本命星番号=3 → 三碧木星

すべてのテストデータが期待される本命星と一致すれば、システムは正常に動作しています。

## 計算ロジックの説明

### 1. 九星用_年の決定
- 生年月日が立春より前 → 前年
- 生年月日が立春以降 → 当年

### 2. 本命星番号の計算
1. 九星用_年の各桁を合計
2. 合計が2桁なら、さらに各桁を合計（1桁になるまで）
3. `11 - (1桁の合計)` を計算
4. 結果が10以上なら9を引く
5. 結果が0なら9にする

### 3. 本命星の変換
番号から星名に変換:
1=一白水星, 2=二黒土星, 3=三碧木星, 4=四緑木星, 5=五黄土星,
6=六白金星, 7=七赤金星, 8=八白土星, 9=九紫火星

## トラブルシューティング

### Formulaがエラーになる場合
- プロパティ名が正確に一致しているか確認
- 日本語の全角・半角、スペースに注意
- Relationが正しく設定されているか確認

### 計算結果が合わない場合
- 節入りカレンダーのRelationが正しく設定されているか確認
- 立春日のデータが正しいか確認（節入りカレンダーDB）

## 参考資料
- 国立天文台暦計算室: https://eco.mtk.nao.ac.jp/koyomi/
- 立春データ: `create_risshun_calendar.py` に1900〜2070年分を収録
