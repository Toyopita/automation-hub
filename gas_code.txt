/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šç· åˆ‡é–“è¿‘ã®ã‚¿ã‚¹ã‚¯ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã‚’ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
 */
function notifyUpcomingTasksAndEvents() {
  const props = PropertiesService.getScriptProperties();
  const NOTION_TOKEN = props.getProperty('NOTION_TOKEN');
  const NOTION_DB_ID = props.getProperty('NOTION_DB_ID');
  const EMAIL_TO = props.getProperty('EMAIL_TO');
  const CALENDAR_IDS = props.getProperty('CALENDAR_IDS'); // 'ç¥–éœŠç¤¾,ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ' ã®ã‚ˆã†ãªå½¢å¼
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã®æ­£ç¢ºãªè¨­å®šï¼ˆå®Ÿéš›ã®IDã‚’ä½¿ç”¨ï¼‰
  // è¡¨ç¤ºé †åº: 1.å…­æ›œ 2.ç¥–éœŠç¤¾ 3.æœ¬ç¤¾ 4.å¹´ç¥­ 5.å†¥ç¦ç¥­ 6.ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ 7.é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆ
  let calendarIds = [
    'br7nsak3pjv3d379ddrf4bfgpo7splo1@import.calendar.google.com',  // å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    'cf7eae583e48c538ae20a84a8d238f9590555ffc283752864fb2252e5ba24555@group.calendar.google.com',  // ç¥–éœŠç¤¾
    '079e3c154e7e09e8bf9844a7d6244981c48f5282252f8ec346286e66018025bb@group.calendar.google.com',  // æœ¬ç¤¾
    '40ea48b73cb27b73af8113fc8d9943a609f1a75e47eb65dd5a126fea516004ea@group.calendar.google.com',  // å¹´ç¥­
    '4985421b6573a758fa7cc5c3c610ee1f725ef2e2e29fa8a758690043dc02c6c5@group.calendar.google.com',  // å†¥ç¦ç¥­
    'izumooyashiro.osaka.takeshi@gmail.com',  // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ
    'ba311ba9532e646a2b72cb8ae66eae3fe2a364b44fcfbf34f7b0f9dbc297b0f0@group.calendar.google.com'  // é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
  ];
  
  if (CALENDAR_IDS) {
    const rawIds = CALENDAR_IDS.split(',').map(id => id.trim());
    calendarIds = rawIds.map(id => {
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‹ã‚‰IDã¸ã®å¤‰æ›
      switch(id) {
        case 'å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼':
          return 'br7nsak3pjv3d379ddrf4bfgpo7splo1@import.calendar.google.com';
        case 'ç¥–éœŠç¤¾':
          return 'cf7eae583e48c538ae20a84a8d238f9590555ffc283752864fb2252e5ba24555@group.calendar.google.com';
        case 'æœ¬ç¤¾':
          return '079e3c154e7e09e8bf9844a7d6244981c48f5282252f8ec346286e66018025bb@group.calendar.google.com';
        case 'å¹´ç¥­':
          return '40ea48b73cb27b73af8113fc8d9943a609f1a75e47eb65dd5a126fea516004ea@group.calendar.google.com';
        case 'å†¥ç¦ç¥­':
          return '4985421b6573a758fa7cc5c3c610ee1f725ef2e2e29fa8a758690043dc02c6c5@group.calendar.google.com';
        case 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ':
          return 'izumooyashiro.osaka.takeshi@gmail.com';
        case 'é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±':
          return 'ba311ba9532e646a2b72cb8ae66eae3fe2a364b44fcfbf34f7b0f9dbc297b0f0@group.calendar.google.com';
        case 'primary':
          return 'izumooyashiro.osaka.takeshi@gmail.com';
        default:
          return id; // ãã®ã¾ã¾ä½¿ç”¨ï¼ˆIDãŒç›´æ¥æŒ‡å®šã•ã‚ŒãŸå ´åˆï¼‰
      }
    });
  }
  
  console.log('å¯¾è±¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼:', calendarIds);
  const DEADLINE_DAYS = 7;

  // Notionã‚¿ã‚¹ã‚¯ã®å–å¾—
  const tasks = fetchTasksFromNotion(NOTION_TOKEN, NOTION_DB_ID);
  const upcomingTasks = filterUpcomingTasks(tasks, DEADLINE_DAYS);
  
  // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã®å–å¾—ï¼ˆæ¡ä»¶æŒ‡å®šå¯èƒ½ï¼‰
  const calendarOptions = {
    excludePrivate: true,        // [ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ]ã‚’å«ã‚€äºˆå®šã‚’é™¤å¤–
    excludeDeclined: true,       // å‚åŠ ã‚’è¾é€€ã—ãŸäºˆå®šã‚’é™¤å¤–
    excludeAllDay: false,        // çµ‚æ—¥äºˆå®šã‚’é™¤å¤–ã—ãªã„
    onlyOwnEvents: false,        // è‡ªåˆ†ãŒä½œæˆã—ãŸäºˆå®šã®ã¿å–å¾—ã—ãªã„
    excludeKeywords: ['ãƒ†ã‚¹ãƒˆ', 'test'], // ç‰¹å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€äºˆå®šã‚’é™¤å¤–
    // includeOnlyCategories: ['é‡è¦', 'ä¼šè­°'], // ç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿å«ã‚ã‚‹
    // excludeCategories: ['ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'],     // ç‰¹å®šã‚«ãƒ†ã‚´ãƒªã‚’é™¤å¤–
    // minGuestCount: 2,          // æœ€ä½å‚åŠ è€…æ•°
    includeToday: true           // ä»Šæ—¥ã®äºˆå®šã‚‚å«ã‚ã‚‹
  };
  const upcomingEvents = fetchUpcomingCalendarEvents(calendarIds, DEADLINE_DAYS, calendarOptions);

  if (upcomingTasks.length > 0 || upcomingEvents.length > 0) {
    sendCombinedEmail(upcomingTasks, upcomingEvents, EMAIL_TO, NOTION_TOKEN);
  } else {
    Logger.log('é€šçŸ¥å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãƒ»äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
  }
}

/**
 * Notionã‹ã‚‰å…¨ã‚¿ã‚¹ã‚¯å–å¾—
 */
function fetchTasksFromNotion(token, dbId) {
  const url = `https://api.notion.com/v1/databases/${dbId}/query`;
  const options = {
    method: 'post',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json',
    },
    payload: JSON.stringify({})
  };
  const response = UrlFetchApp.fetch(url, options);
  const data = JSON.parse(response.getContentText());
  return data.results;
}

/**
 * ç· åˆ‡ãŒè¿‘ãã€ã‹ã¤ã€Œé€²æ—ã€ãŒã€Œæœªäº†ã€ã®ã‚¿ã‚¹ã‚¯ã®ã¿æŠ½å‡º
 * æœŸé™ãŒéãã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚‚æœªäº†ã®å ´åˆã¯é€šçŸ¥å¯¾è±¡ã«å«ã‚ã‚‹
 */
function filterUpcomingTasks(tasks, deadlineDays) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const futureDeadline = new Date(today);
  futureDeadline.setDate(today.getDate() + deadlineDays);
  const TARGET_STATUS = 'æœªäº†';

  return tasks.filter(task => {
    const due = task.properties['æœŸé™']?.date?.start;
    if (!due) return false;
    
    const dueDate = new Date(due);
    dueDate.setHours(0, 0, 0, 0);
    
    const status = (task.properties['é€²æ—']?.status?.name || '').trim();
    if (status !== TARGET_STATUS) return false;

    // æœªäº†ã‚¿ã‚¹ã‚¯ã®å ´åˆï¼š
    // - æœŸé™ãŒéãã¦ã„ã‚‹ã‚‚ã®ï¼ˆä»Šæ—¥ã‚ˆã‚Šå‰ï¼‰â†’ å«ã‚ã‚‹
    // - æœŸé™ãŒä»Šæ—¥ã‹ã‚‰æŒ‡å®šæ—¥æ•°ä»¥å†…ã®ã‚‚ã® â†’ å«ã‚ã‚‹
    // - æœŸé™ãŒæŒ‡å®šæ—¥æ•°ã‚ˆã‚Šå…ˆã®ã‚‚ã® â†’ é™¤å¤–
    const isOverdue = dueDate < today;
    const isWithinDeadline = dueDate >= today && dueDate <= futureDeadline;
    
    return isOverdue || isWithinDeadline;
  });
}

/**
 * è¤‡æ•°ã®Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è¿‘æ—¥ä¸­ã®äºˆå®šã‚’å–å¾—ï¼ˆçµ‚æ—¥äºˆå®šã®æ—¥ä»˜ãšã‚Œä¿®æ­£ç‰ˆï¼‰
 */
function fetchUpcomingCalendarEvents(calendarIds, days, options = {}) {
  let allEvents = [];
  
  // æ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
  const targetCalendars = Array.isArray(calendarIds) ? calendarIds : [calendarIds];
  
  // æ™‚é–“ç¯„å›²ã®è¨­å®šï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ˜ç¤ºçš„ã«å‡¦ç†ï¼‰
  const today = new Date();
  today.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
  
  const startDate = options.includeToday !== false ? new Date(today) : new Date(today.getTime() + 24*60*60*1000);
  const endDate = new Date(today.getTime() + days * 24*60*60*1000);
  endDate.setHours(23, 59, 59, 999); // çµ‚äº†æ—¥ã®æœ€å¾Œã¾ã§å«ã‚ã‚‹

  console.log(`å–å¾—æœŸé–“: ${startDate.toLocaleDateString('ja-JP')} ã€œ ${endDate.toLocaleDateString('ja-JP')}`);

  // å„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰äºˆå®šã‚’å–å¾—
  targetCalendars.forEach(calendarId => {
    try {
      const calendar = CalendarApp.getCalendarById(calendarId || 'primary');
      if (!calendar) {
        Logger.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${calendarId}`);
        return;
      }

      console.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ "${calendar.getName()}" ã‹ã‚‰äºˆå®šã‚’å–å¾—ä¸­...`);
      const events = calendar.getEvents(startDate, endDate);
      console.log(`"${calendar.getName()}" ã‹ã‚‰ ${events.length} ä»¶ã®äºˆå®šã‚’å–å¾—`);
      
      const mappedEvents = events.map(event => {
        const startTime = event.getStartTime();
        const endTime = event.getEndTime();
        const isAllDay = event.isAllDayEvent();
        
        // çµ‚æ—¥äºˆå®šã®å ´åˆã€æ­£ç¢ºãªæ—¥ä»˜ã‚’å–å¾—ã™ã‚‹ãŸã‚ç‰¹åˆ¥å‡¦ç†
        let displayStartDate, displayEndDate;
        let actualStartDate, actualEndDate;
        
        if (isAllDay) {
          // çµ‚æ—¥äºˆå®šã®å ´åˆã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å•é¡Œã§æ—¥ä»˜ãŒãšã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚
          // ã‚ˆã‚Šæ…é‡ã«å‡¦ç†ã™ã‚‹
          
          // startTimeã®ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã‚’ãã®ã¾ã¾ä½¿ç”¨
          // ãŸã ã—ã€æ™‚åˆ»ãŒ0æ™‚ã§ãªã„å ´åˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãšã‚Œï¼‰ã‚’è€ƒæ…®
          let adjustedStartTime = new Date(startTime);
          
          // ã‚‚ã—æ™‚åˆ»ãŒ15æ™‚ä»¥é™ï¼ˆUTCã§ç¿Œæ—¥0æ™‚ï¼JSTã§9æ™‚ã®ã‚±ãƒ¼ã‚¹ï¼‰ãªã‚‰ã€1æ—¥é€²ã‚ã‚‹
          if (adjustedStartTime.getHours() >= 15) {
            adjustedStartTime.setDate(adjustedStartTime.getDate() + 1);
          }
          
          const year = adjustedStartTime.getFullYear();
          const month = adjustedStartTime.getMonth() + 1;
          const date = adjustedStartTime.getDate();
          const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][adjustedStartTime.getDay()];
          displayStartDate = `${year}å¹´${month}æœˆ${date}æ—¥ï¼ˆ${dayOfWeek}ï¼‰`;
          
          // çµ‚äº†æ—¥ã¯çµ‚æ—¥äºˆå®šã®å ´åˆã€endTimeãŒç¿Œæ—¥0æ™‚ã«ãªã£ã¦ã„ã‚‹ã®ã§-1æ—¥ã™ã‚‹
          const adjustedEndTime = new Date(endTime);
          adjustedEndTime.setDate(adjustedEndTime.getDate() - 1);
          const endYear = adjustedEndTime.getFullYear();
          const endMonth = adjustedEndTime.getMonth() + 1;
          const endDate = adjustedEndTime.getDate();
          const endDayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][adjustedEndTime.getDay()];
          displayEndDate = `${endYear}å¹´${endMonth}æœˆ${endDate}æ—¥ï¼ˆ${endDayOfWeek}ï¼‰`;
          
          // æ—¥ä»˜åˆ¤å®šç”¨ã«ã‚‚èª¿æ•´å¾Œã®æ—¥ä»˜ã‚’ä½¿ç”¨
          actualStartDate = new Date(adjustedStartTime.getFullYear(), adjustedStartTime.getMonth(), adjustedStartTime.getDate());
          actualEndDate = new Date(adjustedEndTime.getFullYear(), adjustedEndTime.getMonth(), adjustedEndTime.getDate());
        } else {
          // æ™‚åˆ»æŒ‡å®šã®äºˆå®šã®å ´åˆ
          // toISOString()ã¯UTCã‚’è¿”ã™ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹
          const year = startTime.getFullYear();
          const month = startTime.getMonth() + 1;
          const date = startTime.getDate();
          const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][startTime.getDay()];
          displayStartDate = `${year}å¹´${month}æœˆ${date}æ—¥ï¼ˆ${dayOfWeek}ï¼‰`;
          
          const endYear = endTime.getFullYear();
          const endMonth = endTime.getMonth() + 1;
          const endDate = endTime.getDate();
          const endDayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][endTime.getDay()];
          displayEndDate = `${endYear}å¹´${endMonth}æœˆ${endDate}æ—¥ï¼ˆ${endDayOfWeek}ï¼‰`;
          
          actualStartDate = startTime;
          actualEndDate = endTime;
        }
        
        return {
          title: event.getTitle(),
          startTime: startTime,
          endTime: endTime,
          description: event.getDescription() || '',
          location: event.getLocation() || '',
          isAllDay: isAllDay,
          id: event.getId(),
          calendarName: calendar.getName(),
          calendarId: calendarId,
          guests: event.getGuestList().length,
          isOwnEvent: event.isOwnedByMe(),
          myResponseStatus: event.getMyStatus(),
          // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šå…ƒã®æ—¥ä»˜æƒ…å ±
          originalStartTime: startTime.toISOString(),
          originalEndTime: endTime.toISOString(),
          localStartDate: displayStartDate,
          localEndDate: displayEndDate,
          // æ­£ç¢ºãªæ—¥ä»˜åˆ¤å®šç”¨
          actualStartDate: actualStartDate,
          actualEndDate: actualEndDate
        };
      });
      
      allEvents = allEvents.concat(mappedEvents);
      
    } catch (error) {
      Logger.log(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ "${calendarId}" ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ${error}`);
    }
  });

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
  const filteredEvents = allEvents.filter(event => {
    // åŸºæœ¬çš„ãªé™¤å¤–æ¡ä»¶
    if (!event.title || event.title === '(ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)') {
      console.log(`é™¤å¤–: ã‚¿ã‚¤ãƒˆãƒ«ãªã—/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ - ${event.title}`);
      return false;
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ æ¡ä»¶ã®é©ç”¨
    if (options.excludePrivate && event.title.includes('[ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ]')) {
      console.log(`é™¤å¤–: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ - ${event.title}`);
      return false;
    }
    if (options.excludeDeclined && event.myResponseStatus === CalendarApp.GuestStatus.NO) {
      console.log(`é™¤å¤–: è¾é€€æ¸ˆã¿ - ${event.title}`);
      return false;
    }
    if (options.onlyOwnEvents && !event.isOwnEvent) {
      console.log(`é™¤å¤–: è‡ªåˆ†ä»¥å¤–ãŒä½œæˆ - ${event.title}`);
      return false;
    }
    if (options.excludeAllDay && event.isAllDay) {
      console.log(`é™¤å¤–: çµ‚æ—¥äºˆå®š - ${event.title}`);
      return false;
    }
    if (options.excludeKeywords) {
      const titleLower = event.title.toLowerCase();
      if (options.excludeKeywords.some(keyword => titleLower.includes(keyword.toLowerCase()))) {
        console.log(`é™¤å¤–: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ - ${event.title}`);
        return false;
      }
    }
    
    console.log(`å«ã‚ã‚‹: ${event.title} (${event.localStartDate} ${event.calendarName})`);
    return true;
  });

  // é–‹å§‹æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
  filteredEvents.sort((a, b) => a.actualStartDate - b.actualStartDate);
  
  console.log(`æœ€çµ‚çš„ã« ${filteredEvents.length} ä»¶ã®äºˆå®šã‚’å–å¾—`);
  return filteredEvents;
}

/**
 * ã‚¿ã‚¹ã‚¯ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã‚’çµ±åˆã—ãŸHTMLãƒ¡ãƒ¼ãƒ«é€ä¿¡
 */
function sendCombinedEmail(tasks, events, emailTo, notionToken) {
  const subject = 'ğŸ“…ã€ä»Šé€±ã®äºˆå®šãƒ»ç· åˆ‡é–“è¿‘ã‚¿ã‚¹ã‚¯ã€‘çµ±åˆé€šçŸ¥';
  
  const today = new Date();
  const todayStr = formatJapaneseDate(today.toISOString().split('T')[0]);
  
  console.log('=== ãƒ¡ãƒ¼ãƒ«é€ä¿¡æº–å‚™ ===');
  console.log('äºˆå®šæ•°:', events.length);
  events.forEach((event, index) => {
    console.log(`${index + 1}. ${event.title}`);
    console.log(`   localStartDate: ${event.localStartDate}`);
    console.log(`   çµ‚æ—¥ãƒ•ãƒ©ã‚°: ${event.isAllDay}`);
    console.log(`   å…ƒstartTime: ${event.startTime}`);
  });
  
  let htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                max-width: 700px;
                margin: 0 auto;
                background-color: #f5f5f5;
                padding: 20px;
            }
            .container {
                background-color: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 3px solid #4285f4;
            }
            .header h1 {
                color: #4285f4;
                margin: 0;
                font-size: 24px;
            }
            .date-info {
                background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                color: white;
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                margin-bottom: 25px;
                font-weight: bold;
            }
            .section {
                margin-bottom: 35px;
            }
            .section-title {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 20px;
                margin: 0 0 15px 0;
                border-radius: 8px;
                font-size: 18px;
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .section-title.tasks {
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            }
            .section-title.events {
                background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            }
            .count-badge {
                background-color: rgba(255,255,255,0.2);
                padding: 4px 12px;
                border-radius: 15px;
                font-size: 14px;
                margin-left: auto;
            }
            .content-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .content-table th {
                background-color: #f8f9fa;
                color: #495057;
                padding: 12px;
                text-align: left;
                font-weight: bold;
                border-bottom: 2px solid #dee2e6;
            }
            .content-table td {
                padding: 12px;
                border-bottom: 1px solid #eee;
                vertical-align: top;
            }
            .content-table tr:last-child td {
                border-bottom: none;
            }
            .content-table tr:nth-child(even) {
                background-color: #f8f9fa;
            }
            .content-table tr:hover {
                background-color: #e3f2fd;
                transition: background-color 0.3s ease;
            }
            .task-name, .event-title {
                font-weight: bold;
                color: #2c3e50;
                font-size: 15px;
            }
            .project-name {
                background-color: #e3f2fd;
                color: #1976d2;
                padding: 4px 8px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
                display: inline-block;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .due-date, .event-time {
                font-weight: bold;
            }
            .due-today, .event-today {
                color: #e74c3c;
                background-color: #ffebee;
                padding: 4px 8px;
                border-radius: 5px;
            }
            .due-soon, .event-soon {
                color: #f39c12;
                background-color: #fef9e7;
                padding: 4px 8px;
                border-radius: 5px;
            }
            .event-location {
                color: #666;
                font-size: 13px;
                margin-top: 4px;
            }
            .event-description {
                color: #666;
                font-size: 12px;
                margin-top: 4px;
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .all-day-badge {
                background-color: #34a853;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: bold;
                margin-left: 8px;
            }
            .urgent-badge {
                background-color: #ff6b6b;
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 10px;
                font-weight: bold;
                margin-left: 5px;
            }
            .urgent-badge.overdue {
                background-color: #dc3545;
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.7; }
                100% { opacity: 1; }
            }
            .no-items {
                text-align: center;
                color: #666;
                font-style: italic;
                padding: 30px;
                background-color: #f8f9fa;
                border-radius: 8px;
            }
            .footer {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
                text-align: center;
                color: #666;
                font-size: 12px;
            }
            @media (max-width: 700px) {
                body { padding: 10px; }
                .container { padding: 20px; }
                .content-table th, .content-table td { padding: 8px; font-size: 13px; }
                .section-title { font-size: 16px; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ“… ä»Šé€±ã®äºˆå®šãƒ»ç· åˆ‡ã‚¿ã‚¹ã‚¯çµ±åˆé€šçŸ¥</h1>
            </div>
            
            <div class="date-info">
                ğŸ“… ${todayStr} ã‹ã‚‰1é€±é–“ã®äºˆå®šã¨ã‚¿ã‚¹ã‚¯çŠ¶æ³
            </div>`;

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¥ã«åˆ†é›¢ã—ã¦è¡¨ç¤º
  // è¡¨ç¤ºé †åºã®å®šç¾©ï¼ˆç¥–éœŠç¤¾ã€æœ¬ç¤¾ã€å¹´ç¥­ã€å†¥ç¦ç¥­ã¯çµ±åˆï¼‰
  const displaySections = [
    {
      title: 'å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
      calendarIds: ['br7nsak3pjv3d379ddrf4bfgpo7splo1@import.calendar.google.com'],
      todayOnly: true
    },
    {
      title: 'ç¥ç¤¾ï¼ˆç¥–éœŠç¤¾ãƒ»æœ¬ç¤¾ãƒ»å¹´ç¥­ãƒ»å†¥ç¦ç¥­ï¼‰',
      calendarIds: [
        'cf7eae583e48c538ae20a84a8d238f9590555ffc283752864fb2252e5ba24555@group.calendar.google.com',  // ç¥–éœŠç¤¾
        '079e3c154e7e09e8bf9844a7d6244981c48f5282252f8ec346286e66018025bb@group.calendar.google.com',  // æœ¬ç¤¾
        '40ea48b73cb27b73af8113fc8d9943a609f1a75e47eb65dd5a126fea516004ea@group.calendar.google.com',  // å¹´ç¥­
        '4985421b6573a758fa7cc5c3c610ee1f725ef2e2e29fa8a758690043dc02c6c5@group.calendar.google.com'   // å†¥ç¦ç¥­
      ],
      todayOnly: false
    },
    {
      title: 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ',
      calendarIds: ['izumooyashiro.osaka.takeshi@gmail.com'],
      todayOnly: false
    },
    {
      title: 'é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±',
      calendarIds: ['ba311ba9532e646a2b72cb8ae66eae3fe2a364b44fcfbf34f7b0f9dbc297b0f0@group.calendar.google.com'],
      todayOnly: false
    }
  ];

  // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
  displaySections.forEach(section => {
    const sectionEvents = [];
    
    // ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åé›†
    events.forEach(event => {
      if (!section.calendarIds.includes(event.calendarId)) {
        return; // ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã¯ãªã„
      }
      
      // å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯ä»Šæ—¥ã®äºˆå®šã®ã¿å«ã‚ã‚‹
      if (section.todayOnly) {
        const eventDate = new Date(event.actualStartDate);
        eventDate.setHours(0, 0, 0, 0);
        const todayDate = new Date(today);
        todayDate.setHours(0, 0, 0, 0);
        
        if (eventDate.getTime() !== todayDate.getTime()) {
          return; // ä»Šæ—¥ä»¥å¤–ã¯é™¤å¤–
        }
      }
      
      sectionEvents.push(event);
    });
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (sectionEvents.length === 0) return;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å§‹æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
    sectionEvents.sort((a, b) => a.actualStartDate - b.actualStartDate);

    const calendarEvents = sectionEvents;

    htmlBody += `
            <div class="section">
                <h2 class="section-title events">
                    ğŸ“… ${section.title}
                    <span class="count-badge">${calendarEvents.length}ä»¶</span>
                </h2>`;

    htmlBody += `
                <table class="content-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">ğŸ“ äºˆå®š</th>
                            <th style="width: 30%;">â° æ—¥æ™‚</th>
                            <th style="width: 30%;">ğŸ“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</th>
                        </tr>
                    </thead>
                    <tbody>`;

    calendarEvents.forEach(event => {
      // æ—¥ä»˜æ¯”è¼ƒç”¨ã«æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸæ—¥ä»˜ã‚’ä½¿ç”¨
      const eventDateOnly = new Date(event.actualStartDate);
      eventDateOnly.setHours(0, 0, 0, 0);
      
      const todayDateOnly = new Date(today);
      todayDateOnly.setHours(0, 0, 0, 0);
      
      const diffTime = eventDateOnly - todayDateOnly;
      const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
      
      let timeClass = 'event-time';
      let urgentBadge = '';
      if (diffDays === 0) {
        timeClass = 'event-today';
        urgentBadge = '<span class="urgent-badge">ä»Šæ—¥</span>';
      } else if (diffDays > 0 && diffDays <= 2) {
        timeClass = 'event-soon';
        urgentBadge = '<span class="urgent-badge">ä»Šé€±</span>';
      } else if (diffDays < 0) {
        // éå»ã®äºˆå®šï¼ˆæœ¬æ¥ã¯è¡¨ç¤ºã•ã‚Œãªã„ã¯ãšã ãŒã€å¿µã®ãŸã‚ï¼‰
        timeClass = 'event-time';
        urgentBadge = '';
      }

      const timeStr = event.isAllDay 
        ? `${event.localStartDate}<span class="all-day-badge">çµ‚æ—¥</span>`
        : `${event.localStartDate} ${formatTime(event.startTime)}ã€œ${formatTime(event.endTime)}`;

      const locationInfo = event.location ? `<div class="event-location">ğŸ“ ${event.location}</div>` : '';
      const descriptionInfo = event.description ? `<div class="event-description">${event.description}</div>` : '';
      
      // çµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¥ç¤¾ï¼‰ã®å ´åˆã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã‚’è¡¨ç¤º
      const calendarInfo = section.calendarIds.length > 1 
        ? `<div class="event-location">ğŸ“… ${event.calendarName}</div>` 
        : '';

      htmlBody += `
                        <tr>
                            <td class="event-title">${event.title}${urgentBadge}${locationInfo}${descriptionInfo}</td>
                            <td class="${timeClass}">${timeStr}</td>
                            <td>${calendarInfo}</td>
                        </tr>`;
    });

    htmlBody += `
                    </tbody>
                </table>
            </div>`;
  });

  // Notionã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  htmlBody += `
            <div class="section">
                <h2 class="section-title tasks">
                    ğŸš¨ ç· åˆ‡é–“è¿‘ã‚¿ã‚¹ã‚¯ï¼ˆæœªäº†ï¼‰
                    <span class="count-badge">${tasks.length}ä»¶</span>
                </h2>`;

  if (tasks.length > 0) {
    htmlBody += `
                <table class="content-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
                            <th style="width: 45%;">ğŸ“ ã‚¿ã‚¹ã‚¯å</th>
                            <th style="width: 30%;">â° ç· åˆ‡æ—¥</th>
                        </tr>
                    </thead>
                    <tbody>`;

    const sortedTasks = tasks.sort((a, b) => {
      const dateA = new Date(a.properties['æœŸé™']?.date?.start);
      const dateB = new Date(b.properties['æœŸé™']?.date?.start);
      return dateA - dateB;
    });

    sortedTasks.forEach(task => {
      const title = task.properties['ã‚¿ã‚¹ã‚¯å']?.title?.[0]?.plain_text || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
      const dueRaw = task.properties['æœŸé™']?.date?.start || '';
      const dueFormatted = formatJapaneseDate(dueRaw);
      
      const dueDate = new Date(dueRaw);
      const diffTime = dueDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      let dueDateClass = 'due-date';
      let urgentBadge = '';
      
      if (diffDays < 0) {
        // æœŸé™ãŒéãã¦ã„ã‚‹å ´åˆ
        dueDateClass = 'due-today'; // èµ¤è‰²ã§è¡¨ç¤º
        urgentBadge = '<span class="urgent-badge overdue">æœŸé™è¶…é</span>';
      } else if (diffDays <= 0) {
        dueDateClass = 'due-today';
        urgentBadge = '<span class="urgent-badge">ä»Šæ—¥</span>';
      } else if (diffDays <= 3) {
        dueDateClass = 'due-soon';
        urgentBadge = '<span class="urgent-badge">ä»Šé€±</span>';
      }

      const relation = task.properties['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå']?.relation;
      let projectName = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªè¨­å®š';
      if (relation && relation.length > 0) {
        const projectId = relation[0].id;
        projectName = fetchProjectNameById(projectId, notionToken) || 'ä¸æ˜';
      }

      htmlBody += `
                        <tr>
                            <td><span class="project-name">${projectName}</span></td>
                            <td class="task-name">${title}${urgentBadge}</td>
                            <td class="${dueDateClass}">${dueFormatted}</td>
                        </tr>`;
    });

    htmlBody += `
                    </tbody>
                </table>`;
  } else {
    htmlBody += `<div class="no-items">âœ… ç· åˆ‡é–“è¿‘ã®æœªäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }

  htmlBody += `
            </div>
            
            <div class="footer">
                <p>ğŸ’¡ <strong>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™</strong></p>
                <p>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã®ç¢ºèªã¨Notionã‚¿ã‚¹ã‚¯ã®é€²æ—æ›´æ–°ã‚’ãŠå¿˜ã‚Œãªã</p>
                <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
                <p style="color: #999; font-size: 11px;">
                    é€ä¿¡æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')} | 
                    å¯¾è±¡æœŸé–“: ä»Šæ—¥ã‹ã‚‰${7}æ—¥é–“ï¼ˆå…­æ›œã¯å½“æ—¥ã®ã¿ï¼‰
                </p>
            </div>
        </div>
    </body>
    </html>
  `;

  MailApp.sendEmail({
    to: emailTo,
    subject: subject,
    htmlBody: htmlBody
  });
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå–å¾—ï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡ºï¼‰
 */
function fetchProjectNameById(pageId, token) {
  const url = `https://api.notion.com/v1/pages/${pageId}`;
  const options = {
    method: 'get',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json',
    }
  };
  try {
    const response = UrlFetchApp.fetch(url, options);
    const data = JSON.parse(response.getContentText());
    const titleProp = Object.values(data.properties).find(p => p.type === 'title');
    return titleProp?.title?.[0]?.plain_text || '(ç„¡å)';
  } catch (e) {
    Logger.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—å¤±æ•—: ' + e);
    return '(å–å¾—å¤±æ•—)';
  }
}

/**
 * å’Œå¼æ—¥ä»˜ï¼‹æ›œæ—¥ï¼š2025å¹´4æœˆ30æ—¥ï¼ˆæ°´ï¼‰å½¢å¼
 */
function formatJapaneseDate(dateStr) {
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = d.getMonth() + 1;
  const day = d.getDate();
  const w = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
  return `${y}å¹´${m}æœˆ${day}æ—¥ï¼ˆ${w}ï¼‰`;
}

/**
 * æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼šHH:MMå½¢å¼
 */
function formatTime(date) {
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  return `${hours}:${minutes}`;
}

// ==================== ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ ====================

/**
 * Notionã‚¿ã‚¹ã‚¯ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çŠ¶æ³ã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹é–¢æ•°
 */
function debugTaskFiltering() {
  const props = PropertiesService.getScriptProperties();
  const NOTION_TOKEN = props.getProperty('NOTION_TOKEN');
  const NOTION_DB_ID = props.getProperty('NOTION_DB_ID');
  const DEADLINE_DAYS = 7;

  console.log('=== Notionã‚¿ã‚¹ã‚¯ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
  console.log('ä»Šæ—¥ã®æ—¥ä»˜:', new Date().toLocaleDateString('ja-JP'));
  
  // å…¨ã‚¿ã‚¹ã‚¯å–å¾—
  const allTasks = fetchTasksFromNotion(NOTION_TOKEN, NOTION_DB_ID);
  console.log('å–å¾—ã—ãŸå…¨ã‚¿ã‚¹ã‚¯æ•°:', allTasks.length);
  
  // å„ã‚¿ã‚¹ã‚¯ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
  console.log('\n=== å…¨ã‚¿ã‚¹ã‚¯ã®è©³ç´° ===');
  allTasks.forEach((task, index) => {
    const title = task.properties['ã‚¿ã‚¹ã‚¯å']?.title?.[0]?.plain_text || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
    const dueRaw = task.properties['æœŸé™']?.date?.start || '';
    const status = (task.properties['é€²æ—']?.status?.name || '').trim();
    
    console.log(`${index + 1}. ${title}`);
    console.log(`   æœŸé™: ${dueRaw}`);
    console.log(`   é€²æ—: "${status}"`);
    
    if (dueRaw) {
      const dueDate = new Date(dueRaw);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      dueDate.setHours(0, 0, 0, 0);
      
      const diffTime = dueDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      console.log(`   æœŸé™æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: ${dueDate}`);
      console.log(`   ä»Šæ—¥ã¨ã®å·®: ${diffDays}æ—¥`);
      console.log(`   æœŸé™éã?: ${dueDate < today ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
    }
    console.log('---');
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ
  const filteredTasks = filterUpcomingTasks(allTasks, DEADLINE_DAYS);
  console.log('\n=== ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœ ===');
  console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ã‚¿ã‚¹ã‚¯æ•°:', filteredTasks.length);
  
  if (filteredTasks.length > 0) {
    console.log('\n=== é€šçŸ¥å¯¾è±¡ã‚¿ã‚¹ã‚¯ ===');
    filteredTasks.forEach((task, index) => {
      const title = task.properties['ã‚¿ã‚¹ã‚¯å']?.title?.[0]?.plain_text || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
      const dueRaw = task.properties['æœŸé™']?.date?.start || '';
      const status = (task.properties['é€²æ—']?.status?.name || '').trim();
      
      console.log(`${index + 1}. ${title} (æœŸé™: ${dueRaw}, é€²æ—: ${status})`);
    });
  } else {
    console.log('âŒ é€šçŸ¥å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
  }
  
  // ç‰¹å®šã®æ¡ä»¶ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
  console.log('\n=== æ¡ä»¶åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ===');
  
  // æœªäº†ã‚¿ã‚¹ã‚¯ã®ã¿
  const incompleteTasks = allTasks.filter(task => {
    const status = (task.properties['é€²æ—']?.status?.name || '').trim();
    return status === 'æœªäº†';
  });
  console.log('æœªäº†ã‚¿ã‚¹ã‚¯æ•°:', incompleteTasks.length);
  
  // æœŸé™ã‚ã‚Šã‚¿ã‚¹ã‚¯ã®ã¿
  const tasksWithDue = allTasks.filter(task => {
    return task.properties['æœŸé™']?.date?.start;
  });
  console.log('æœŸé™è¨­å®šæ¸ˆã¿ã‚¿ã‚¹ã‚¯æ•°:', tasksWithDue.length);
  
  // æœªäº†ã‹ã¤æœŸé™ã‚ã‚Šã‚¿ã‚¹ã‚¯
  const incompleteWithDue = allTasks.filter(task => {
    const status = (task.properties['é€²æ—']?.status?.name || '').trim();
    const due = task.properties['æœŸé™']?.date?.start;
    return status === 'æœªäº†' && due;
  });
  console.log('æœªäº†ã‹ã¤æœŸé™è¨­å®šæ¸ˆã¿ã‚¿ã‚¹ã‚¯æ•°:', incompleteWithDue.length);
  
  if (incompleteWithDue.length > 0) {
    console.log('\n=== æœªäº†ã‹ã¤æœŸé™è¨­å®šæ¸ˆã¿ã‚¿ã‚¹ã‚¯ã®è©³ç´° ===');
    incompleteWithDue.forEach((task, index) => {
      const title = task.properties['ã‚¿ã‚¹ã‚¯å']?.title?.[0]?.plain_text || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
      const dueRaw = task.properties['æœŸé™']?.date?.start;
      const dueDate = new Date(dueRaw);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      dueDate.setHours(0, 0, 0, 0);
      
      const isOverdue = dueDate < today;
      const futureDeadline = new Date(today);
      futureDeadline.setDate(today.getDate() + DEADLINE_DAYS);
      const isWithinDeadline = dueDate >= today && dueDate <= futureDeadline;
      
      console.log(`${index + 1}. ${title}`);
      console.log(`   æœŸé™: ${dueRaw}`);
      console.log(`   æœŸé™éã: ${isOverdue ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
      console.log(`   æœŸé™å†…: ${isWithinDeadline ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
      console.log(`   é€šçŸ¥å¯¾è±¡: ${(isOverdue || isWithinDeadline) ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
      console.log('---');
    });
  }
}

/**
 * ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šãªã—ã€ã‚¿ã‚¹ã‚¯ã®ã¿ï¼‰
 */
function testEmailSending() {
  const props = PropertiesService.getScriptProperties();
  const NOTION_TOKEN = props.getProperty('NOTION_TOKEN');
  const NOTION_DB_ID = props.getProperty('NOTION_DB_ID');
  const EMAIL_TO = props.getProperty('EMAIL_TO');
  const DEADLINE_DAYS = 7;

  console.log('=== ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ===');
  
  // Notionã‚¿ã‚¹ã‚¯å–å¾—
  const tasks = fetchTasksFromNotion(NOTION_TOKEN, NOTION_DB_ID);
  const upcomingTasks = filterUpcomingTasks(tasks, DEADLINE_DAYS);
  console.log('é€šçŸ¥å¯¾è±¡ã‚¿ã‚¹ã‚¯æ•°:', upcomingTasks.length);
  
  // æœŸé™éãã‚¿ã‚¹ã‚¯ã®è©³ç´°ç¢ºèª
  const overdueTasks = upcomingTasks.filter(task => {
    const dueRaw = task.properties['æœŸé™']?.date?.start;
    if (!dueRaw) return false;
    const dueDate = new Date(dueRaw);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    dueDate.setHours(0, 0, 0, 0);
    return dueDate < today;
  });
  
  console.log('æœŸé™éãã‚¿ã‚¹ã‚¯æ•°:', overdueTasks.length);
  overdueTasks.forEach((task, index) => {
    const title = task.properties['ã‚¿ã‚¹ã‚¯å']?.title?.[0]?.plain_text || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰';
    const dueRaw = task.properties['æœŸé™']?.date?.start;
    console.log(`${index + 1}. ${title} (æœŸé™: ${dueRaw})`);
  });
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã¯ç©ºé…åˆ—ã§ãƒ†ã‚¹ãƒˆ
  const upcomingEvents = [];
  
  if (EMAIL_TO) {
    console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™...');
    console.log('é€ä¿¡å…ˆ:', EMAIL_TO);
    
    try {
      sendCombinedEmail(upcomingTasks, upcomingEvents, EMAIL_TO, NOTION_TOKEN);
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
    } catch (error) {
      console.log('âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      console.log('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
    }
  } else {
    console.log('âŒ EMAIL_TOãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
  }
}

/**
 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šã®ãƒ‡ãƒãƒƒã‚°ç¢ºèªï¼ˆè¤‡æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»æ—¥ä»˜è©³ç´°è¡¨ç¤ºå¯¾å¿œï¼‰
 */
function debugCalendarEvents() {
  const props = PropertiesService.getScriptProperties();
  const CALENDAR_IDS = props.getProperty('CALENDAR_IDS') || 'primary';
  const calendarIds = CALENDAR_IDS.split(',').map(id => id.trim());
  
  console.log('=== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šç¢ºèª ===');
  console.log('CALENDAR_IDS:', CALENDAR_IDS);
  console.log('å¯¾è±¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é…åˆ—:', calendarIds);
  
  // æ¡ä»¶ãªã—ã§å…¨äºˆå®šå–å¾—
  console.log('\n=== æ¡ä»¶ãªã—ã§å…¨äºˆå®šå–å¾— ===');
  try {
    const allEvents = fetchUpcomingCalendarEvents(calendarIds, 7, {});
    console.log('å…¨äºˆå®šæ•°:', allEvents.length);
    
    console.log('\n=== å–å¾—ã—ãŸäºˆå®šä¸€è¦§ï¼ˆè©³ç´°ï¼‰===');
    allEvents.forEach((event, index) => {
      console.log(`${index + 1}. ${event.title}`);
      console.log(`   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${event.calendarName}`);
      console.log(`   é–‹å§‹æ™‚åˆ»: ${event.startTime.toLocaleString('ja-JP')}`);
      console.log(`   çµ‚äº†æ™‚åˆ»: ${event.endTime.toLocaleString('ja-JP')}`);
      console.log(`   é–‹å§‹æ—¥ä»˜: ${event.localStartDate}`);
      console.log(`   çµ‚æ—¥ãƒ•ãƒ©ã‚°: ${event.isAllDay ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
      console.log(`   å ´æ‰€: ${event.location || 'æœªè¨­å®š'}`);
      console.log(`   å‚åŠ è€…æ•°: ${event.guests}äºº`);
      console.log(`   ISOé–‹å§‹: ${event.originalStartTime}`);
      console.log(`   ISOçµ‚äº†: ${event.originalEndTime}`);
      console.log('---');
    });
    
    console.log('\n=== æ—¥ä»˜åˆ¥äºˆå®š ===');
    const eventsByDate = {};
    allEvents.forEach(event => {
      const dateKey = event.localStartDate;
      if (!eventsByDate[dateKey]) {
        eventsByDate[dateKey] = [];
      }
      eventsByDate[dateKey].push(event);
    });
    
    Object.keys(eventsByDate).sort((a, b) => {
      // æ—¥æœ¬èªæ—¥ä»˜æ–‡å­—åˆ—ã®ã‚½ãƒ¼ãƒˆï¼ˆå¹´æœˆæ—¥ã§æ¯”è¼ƒï¼‰
      const dateA = new Date(a.replace(/å¹´|æœˆ|æ—¥|\(.\)/g, '/').replace(/\/$/, ''));
      const dateB = new Date(b.replace(/å¹´|æœˆ|æ—¥|\(.\)/g, '/').replace(/\/$/, ''));
      return dateA - dateB;
    }).forEach(date => {
      console.log(`\nğŸ“… ${date}:`);
      eventsByDate[date].forEach(event => {
        console.log(`  - ${event.title} (${event.calendarName})`);
      });
    });
    
  } catch (error) {
    console.log('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    console.log('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
  }
}

/**
 * çµ±åˆé€šçŸ¥ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
 */
function testCombinedNotification() {
  const props = PropertiesService.getScriptProperties();
  const NOTION_TOKEN = props.getProperty('NOTION_TOKEN');
  const NOTION_DB_ID = props.getProperty('NOTION_DB_ID');
  const CALENDAR_ID = props.getProperty('CALENDAR_ID') || 'primary';
  const DEADLINE_DAYS = 7;

  console.log('=== çµ±åˆé€šçŸ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ===');
  
  // Notionã‚¿ã‚¹ã‚¯å–å¾—
  const tasks = fetchTasksFromNotion(NOTION_TOKEN, NOTION_DB_ID);
  const upcomingTasks = filterUpcomingTasks(tasks, DEADLINE_DAYS);
  console.log('æœªäº†ã‚¿ã‚¹ã‚¯æ•°:', upcomingTasks.length);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼äºˆå®šå–å¾—
  const upcomingEvents = fetchUpcomingCalendarEvents(CALENDAR_ID, DEADLINE_DAYS);
  console.log('è¿‘æ—¥ä¸­ã®äºˆå®šæ•°:', upcomingEvents.length);
  
  console.log('\n=== é€šçŸ¥å¯¾è±¡ã¾ã¨ã‚ ===');
  console.log(`ğŸ“… äºˆå®š: ${upcomingEvents.length}ä»¶`);
  console.log(`ğŸš¨ æœªäº†ã‚¿ã‚¹ã‚¯: ${upcomingTasks.length}ä»¶`);
  
  if (upcomingTasks.length > 0 || upcomingEvents.length > 0) {
    console.log('âœ… é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å¯¾è±¡ãŒã‚ã‚Šã¾ã™');
    
    // ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’æœ‰åŠ¹åŒ–
    const EMAIL_TO = props.getProperty('EMAIL_TO');
    if (EMAIL_TO) {
      console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã—ã¾ã™...');
      sendCombinedEmail(upcomingTasks, upcomingEvents, EMAIL_TO, NOTION_TOKEN);
      console.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
    } else {
      console.log('âŒ EMAIL_TOãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  } else {
    console.log('âŒ é€šçŸ¥å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“');
  }
}

/**
 * è¨­å®šå€¤ç¢ºèªï¼ˆè¤‡æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDå¯¾å¿œç‰ˆï¼‰
 */
function checkAllProperties() {
  const props = PropertiesService.getScriptProperties();
  const keys = ['NOTION_TOKEN', 'NOTION_DB_ID', 'EMAIL_TO', 'CALENDAR_IDS'];
  
  console.log('=== è¨­å®šå€¤ç¢ºèª ===');
  keys.forEach(key => {
    const value = props.getProperty(key);
    console.log(`${key}: ${value ? 'è¨­å®šæ¸ˆã¿' : 'âŒæœªè¨­å®š'}`);
    if (key === 'CALENDAR_IDS') {
      if (value) {
        const calendarIds = value.split(',').map(id => id.trim());
        console.log(`  â†’ å¯¾è±¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: ${calendarIds.join(', ')}`);
      } else {
        console.log('  â†’ CALENDAR_IDSãŒæœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®7ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒä½¿ç”¨ã•ã‚Œã¾ã™');
        console.log('     (å…­æ›œã€ç¥–éœŠç¤¾ã€æœ¬ç¤¾ã€å¹´ç¥­ã€å†¥ç¦ç¥­ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±)');
      }
    }
  });
}

/**
 * è¤‡æ•°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’è¨­å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function setCalendarIds(calendarIds) {
  const props = PropertiesService.getScriptProperties();
  const idsString = Array.isArray(calendarIds) ? calendarIds.join(',') : calendarIds;
  props.setProperty('CALENDAR_IDS', idsString);
  console.log('CALENDAR_IDSã‚’è¨­å®šã—ã¾ã—ãŸ:', idsString);
}

/**
 * ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã€å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ç¥–éœŠç¤¾ã€æœ¬ç¤¾ã€å¹´ç¥­ã€å†¥ç¦ç¥­ã‚’è¨­å®šã™ã‚‹å°‚ç”¨é–¢æ•°
 */
function setupTargetCalendars() {
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åã§è¨­å®šã™ã‚‹å ´åˆï¼ˆè¡¨ç¤ºé †åºã«å¾“ã£ã¦è¨­å®šï¼‰
  setCalendarIds('å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼,ç¥–éœŠç¤¾,æœ¬ç¤¾,å¹´ç¥­,å†¥ç¦ç¥­,ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ,é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±');
  
  console.log('âœ… ä»¥ä¸‹ã®7ã¤ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ:');
  console.log('   1. å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå½“æ—¥ã®ã¿è¡¨ç¤ºï¼‰');
  console.log('   2. ç¥ç¤¾ï¼ˆç¥–éœŠç¤¾ãƒ»æœ¬ç¤¾ãƒ»å¹´ç¥­ãƒ»å†¥ç¦ç¥­ã‚’çµ±åˆè¡¨ç¤ºï¼‰');
  console.log('   3. ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ');
  console.log('   4. é–¢è¥¿ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±');
}

/**
 * åˆ©ç”¨å¯èƒ½ãªå…¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®IDã¨åå‰ã‚’è¡¨ç¤º
 */
function listAllCalendars() {
  const calendars = CalendarApp.getAllCalendars();
  
  console.log('=== åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸€è¦§ ===');
  console.log(`åˆè¨ˆ: ${calendars.length}å€‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼\n`);
  
  calendars.forEach((calendar, index) => {
    console.log(`${index + 1}. ${calendar.getName()}`);
    console.log(`   ID: ${calendar.getId()}`);
    console.log('');
  });
}