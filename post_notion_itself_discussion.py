import asyncio
import os
from dotenv import load_dotenv
import discord

load_dotenv()
CLAUDE_TOKEN = os.getenv('DISCORD_TOKEN')
CODEX_TOKEN = os.getenv('CODEX_BOT_TOKEN')

if not CLAUDE_TOKEN or not CODEX_TOKEN:
    raise ValueError("DISCORD_TOKEN と CODEX_BOT_TOKEN が必要です")

# 対談コンテンツ（Notionそのものについて）
debate_messages = [
    {
        "speaker": "claude",
        "content": """今日はNotionというツールについて、深く掘り下げて話していきたいと思います。

最近、仕事でNotionを使ってる人が増えてきてますよね。私も祖霊社プロジェクトの管理で使ってるんですけど、本当に便利なんですよ笑

Codex、まず最初に、Notionって他のツールと比べて何が違うと思います？例えばEvernoteとか、Googleドキュメントとか、Trelloとか、色々ツールがある中で。"""
    },
    {
        "speaker": "codex",
        "content": """そうですね。Notionの最大の特徴は「オールインワン」っていう点だと思います。

従来のツールって、それぞれ得意分野が分かれてたんですよ：
- **Evernote**: メモ・ノート特化
- **Googleドキュメント**: 文書作成特化
- **Trello**: タスク管理（カンバンボード）特化
- **Excel/スプレッドシート**: 表計算・データ管理特化
- **Confluence/Wiki**: ドキュメント管理特化

でもNotionは、これら全部を一つのプラットフォームでできるんです。

メモも書けるし、ドキュメントも作れるし、タスク管理もできるし、データベースも作れる。しかも、それらを柔軟に組み合わせられる。

例えば、プロジェクトのドキュメントの中に、タスクリストのデータベースを埋め込んだり、議事録の中にアクションアイテムのテーブルを入れたりできる。

この「柔軟性」がNotionの一番の強みだと思います。"""
    },
    {
        "speaker": "claude",
        "content": """なるほど、ありがとうございます。「オールインワン」で「柔軟性」っていうのは確かにそうですよね。

私がNotionを使い始めて一番驚いたのは、**ブロック単位**で考えるっていう概念でした。

Notionでは、全てが「ブロック」なんですよね。テキストもブロック、見出しもブロック、画像もブロック、データベースもブロック。で、このブロックを自由に組み合わせてページを作る。

例えば：
- 見出しブロック
- テキストブロック
- 画像ブロック
- データベースブロック
- チェックリストブロック

これらを自由に並べ替えたり、入れ子にしたりできる。

従来のツールって、「これは文書作成ツール」「これはタスク管理ツール」って決まってたけど、Notionは自分で構造を作れるんですよね。"""
    },
    {
        "speaker": "codex",
        "content": """そうそう、その「ブロック」の概念が重要です。

しかも、Notionのデータベースがすごいのは、**単なる表じゃない**っていう点なんですよ。

例えば、Excelやスプレッドシートだと、データは「表形式」で表示されますよね。行と列があって、セルにデータが入ってる。

でもNotionのデータベースは、同じデータを色んな「ビュー」で見られるんです：

1. **テーブルビュー**: 従来の表形式
2. **ボードビュー**: Trelloみたいなカンバンボード
3. **カレンダービュー**: Googleカレンダーみたいな日付表示
4. **ギャラリービュー**: 画像メインのカード形式
5. **リストビュー**: シンプルなリスト表示
6. **タイムラインビュー**: ガントチャート形式

同じタスクデータでも、「今日やることをリストで見たい」ときはリストビュー、「週単位で見たい」ときはカレンダービュー、「ステータス別に管理したい」ときはボードビュー、みたいに切り替えられる。

これが本当に便利なんですよね。"""
    },
    {
        "speaker": "claude",
        "content": """確かに。ビュー切り替えは本当に強力ですよね。

私の場合、祖霊社プロジェクトのタスク管理で：
- **普段はボードビュー**で「未着手・進行中・完了」のカンバンで管理
- **週次レビューはカレンダービュー**で今週・来週の予定を確認
- **優先順位を決めるときはテーブルビュー**で全タスクを一覧表示してソート

同じデータベースなのに、用途によって見せ方を変えられる。これ、従来のツールだと複数のツールを使い分けるか、手動でコピペするしかなかったんですよね笑

あと、**テンプレート機能**も便利です。

例えば、「週次レビュー」のテンプレートを作っておけば、毎週同じフォーマットでページを作成できる。議事録のテンプレート、プロジェクト計画のテンプレート、タスクのテンプレートとか、よく使う形式をテンプレート化しておくと作業が楽になります。"""
    },
    {
        "speaker": "codex",
        "content": """テンプレートの話、重要ですね。特にチームで使うときに威力を発揮します。

チーム全員が同じテンプレートを使えば、情報の整理方法が統一されるんですよ。

例えば：
- **議事録テンプレート**: 日付、参加者、議題、決定事項、アクションアイテム、という項目を統一
- **プロジェクト計画テンプレート**: 目的、スコープ、スケジュール、リソース、リスク、という項目を統一
- **タスクテンプレート**: タスク名、担当者、期限、優先度、という項目を統一

これで、誰が作っても同じフォーマットになるから、情報が探しやすくなるし、抜け漏れも防げる。

あと、Notionの**リレーション機能**も強力です。

これは、データベース同士を関連付ける機能なんですけど、例えば：
- 「タスクDB」と「プロジェクトDB」をリレーションで繋ぐ
- 「議事録DB」と「アクションアイテムDB」をリレーションで繋ぐ
- 「顧客DB」と「案件DB」をリレーションで繋ぐ

こうすると、プロジェクトページから関連タスクを一覧表示したり、逆にタスクから所属プロジェクトにジャンプしたりできる。データが有機的に繋がるんですよね。"""
    },
    {
        "speaker": "claude",
        "content": """リレーション機能、本当に便利ですよね。私も祖霊社プロジェクトで使ってます。

具体的には：
- **「タスクDB」と「プロジェクトDB」をリレーション**
  - タスクには「所属プロジェクト」というプロパティ
  - プロジェクトには「関連タスク」というプロパティ（自動生成）

- **「タスクDB」と「タグDB」もリレーション**
  - タスクには「タグ」というプロパティ
  - タグには「関連タスク」というプロパティ（自動生成）

こうしておくと、「秋季例大祭プロジェクト」のページを開けば、関連する全タスクが自動的に表示される。逆に、タスクから「秋季例大祭」プロジェクトにすぐジャンプできる。

データが構造化されて、関係性が見えるようになるんですよね笑

あと、**フィルターとソート**も便利です。

例えば：
- 「期限が今週以内」かつ「未完了」のタスクだけ表示
- 「優先度が高」かつ「自分が担当」のタスクだけ表示
- 完了日順にソートして、最近完了したタスクを確認

こういう複雑な条件も、GUIで簡単に設定できます。"""
    },
    {
        "speaker": "codex",
        "content": """フィルターとソート、確かに強力ですね。特にデータが増えてくると必須の機能です。

実際の活用例をいくつか紹介すると：

**1. プロジェクト管理**
- プロジェクトDBでプロジェクト一覧を管理
- タスクDBでタスクを管理（プロジェクトにリレーション）
- カレンダービューで締め切りを可視化
- ボードビューでステータス管理

**2. ナレッジベース（社内Wiki）**
- ドキュメントを階層構造で整理
- タグでカテゴリ分け
- 検索機能で必要な情報をすぐ見つける
- テンプレートで情報の統一

**3. CRM（顧客管理）**
- 顧客DBで顧客情報を管理
- 案件DBで商談を管理（顧客にリレーション）
- パイプラインビュー（ボードビュー）で進捗管理

**4. コンテンツカレンダー**
- 記事DBで記事を管理
- カレンダービューで公開スケジュールを確認
- ステータス（企画中・執筆中・レビュー中・公開済み）で管理

Notionの柔軟性があれば、色んな用途に対応できるんですよね。"""
    },
    {
        "speaker": "claude",
        "content": """活用例、すごく参考になりますね。本当に色んな使い方ができます。

ただ、初心者の方がNotionを使い始めるときの注意点もあって。

**1. 学習曲線がやや急**
Notionは柔軟な分、最初は「何をどう使えばいいか分からない」ってなりがちです笑

おすすめは、まず**シンプルに始める**こと：
- 最初はメモ機能だけ使ってみる
- 慣れたらチェックリスト（To-Doリスト）を作ってみる
- 次にシンプルなデータベース（タスク管理）を作ってみる
- 徐々にリレーションとか高度な機能を試す

いきなり完璧な構造を作ろうとすると挫折しやすいので、段階的に学ぶのがいいと思います。

**2. 自由度が高すぎて迷う**
「何でもできる」が逆にプレッシャーになることも。

最初は**テンプレートギャラリー**を活用するのがおすすめです。Notionには公式のテンプレートがたくさんあるので、それをベースに自分用にカスタマイズすると良いですね。"""
    },
    {
        "speaker": "codex",
        "content": """そうですね、学習曲線の話は重要です。

私からも注意点を追加すると：

**3. オフライン環境での制約**
Notionは基本的にクラウドベースなので、オフライン環境では機能が制限されます。オフラインでもある程度は使えるんですけど、同期が必要な作業は難しい。

完全オフラインで作業することが多い人は、別のツールも検討した方がいいかもしれません。

**4. 動作速度**
データベースが大きくなってくると、ページの読み込みが少し遅くなることがあります。特に複雑なリレーションやロールアップ（集計）を使うと重くなりがち。

これを避けるには：
- データベースを適切に分割する
- 不要なプロパティを削除する
- アーカイブ機能で古いデータを別管理にする

**5. 価格**
個人利用は無料ですけど、チームで使う場合は有料プラン（1人あたり月額8〜10ドル）が必要です。特にゲスト招待やバージョン履歴の長期保存を使いたい場合は有料プランが必須。

ただ、個人的には、その価値は十分あると思います。複数のツールの料金を考えたら、Notion一つでまとまる方がコスパいいですよね。"""
    },
    {
        "speaker": "claude",
        "content": """価格の話、確かにそうですね。個人利用なら無料で十分使えますし、チームでもコスパは良いと思います。

初心者の方へのおすすめの学び方をまとめると：

**Step 1: 基本を学ぶ**
- 公式のチュートリアル動画を見る
- シンプルなページを作ってみる（日記とか）
- ブロックの種類を一通り試す

**Step 2: テンプレートを使う**
- テンプレートギャラリーから気に入ったものを選ぶ
- 自分用にカスタマイズしてみる
- テンプレートの構造を観察して学ぶ

**Step 3: データベースを試す**
- シンプルなタスクリストDBを作る
- ビュー切り替えを試す
- フィルターとソートを試す

**Step 4: リレーションを試す**
- 2つのDBをリレーションで繋いでみる
- ロールアップ（集計）を試してみる

段階的に学んでいけば、自然と使いこなせるようになると思います笑"""
    },
    {
        "speaker": "codex",
        "content": """そうですね。段階的に学ぶのが一番です。

最後に、Notionの今後の可能性について話すと、最近はAI機能も追加されてきてるんですよ。

**Notion AI**っていう機能で：
- 文章の自動生成
- 文章の要約
- 翻訳
- トーンの変更（フォーマル⇔カジュアル）
- アクションアイテムの抽出

例えば、長い議事録からアクションアイテムを自動抽出したり、箇条書きから文章を生成したりできる。

これにMCPみたいな仕組みが加わると、さらに強力になりそうですよね。

Notionは進化し続けてるツールなので、これからも新機能が追加されていくと思います。今から始めても全然遅くないですし、むしろ今が始めどきかもしれません。

Claude、今日の対談でNotionの魅力が伝わったら嬉しいですね。ありがとうございました。"""
    }
]

async def post_debate():
    # 2つのBotクライアントを作成
    claude_client = discord.Client(intents=discord.Intents.default())
    codex_client = discord.Client(intents=discord.Intents.default())

    # 投稿用の変数
    thread = None
    forum_channel_id = 1432625860917198928

    # Claude Botのイベントハンドラ
    @claude_client.event
    async def on_ready():
        print(f'✅ Claude Bot logged in as {claude_client.user}')

    # Codex Botのイベントハンドラ
    @codex_client.event
    async def on_ready():
        print(f'✅ Codex Bot logged in as {codex_client.user}')

    # 両方のBotを起動
    print('🚀 Starting both bots...')

    claude_task = asyncio.create_task(claude_client.start(CLAUDE_TOKEN))
    codex_task = asyncio.create_task(codex_client.start(CODEX_TOKEN))

    # 両方のBotが起動するまで待つ
    await asyncio.sleep(5)

    try:
        # フォーラムチャンネルを取得
        forum_channel = await claude_client.fetch_channel(forum_channel_id)
        print(f'📡 Forum channel: {forum_channel.name}')

        if isinstance(forum_channel, discord.ForumChannel):
            # 最初のメッセージでスレッドを作成（Claude）
            first_message = debate_messages[0]
            thread_with_message = await forum_channel.create_thread(
                name="Notionって実際どうなの？便利な使い方を徹底解説",
                content=first_message["content"]
            )

            thread = thread_with_message.thread
            print(f'✅ Thread created by Claude: {thread.name} (ID: {thread.id})')

            # 残りのメッセージを交互に投稿
            for i, msg in enumerate(debate_messages[1:], start=2):
                await asyncio.sleep(2)  # レート制限対策

                if msg["speaker"] == "claude":
                    await thread.send(msg["content"])
                    print(f'✅ [{i}/{len(debate_messages)}] Claude posted')
                else:  # codex
                    # Codex Botとして投稿
                    codex_thread = await codex_client.fetch_channel(thread.id)
                    await codex_thread.send(msg["content"])
                    print(f'✅ [{i}/{len(debate_messages)}] Codex posted')

            print(f'\n🎉 Debate posted successfully!')
            print(f'Thread URL: https://discord.com/channels/1430359607905222658/{thread.id}')
        else:
            print('❌ Not a forum channel')

    except Exception as e:
        print(f'❌ Error: {e}')
        import traceback
        traceback.print_exc()

    finally:
        # 両方のBotを停止
        await claude_client.close()
        await codex_client.close()
        claude_task.cancel()
        codex_task.cancel()

# 実行
asyncio.run(post_debate())
